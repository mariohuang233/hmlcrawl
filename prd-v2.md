# PRD：分布式电力数据爬取与监控系统

## 一、项目概述

### 1.1 项目背景
随着智能电表的普及，用户对实时掌握家庭用电情况的需求日益增长。本项目旨在开发一个基于浏览器的分布式电力数据爬取与监控系统，通过利用用户浏览器进行分布式爬取，解决传统服务器爬虫可能面临的IP封禁、访问限制等问题，实现高效、稳定的电力数据采集与可视化。

### 1.2 项目目标
- **分布式爬取**：利用用户浏览器进行电力数据爬取，每2分钟自动执行一次
- **数据可视化**：提供直观的电力使用情况展示，包括剩余电量、历史趋势等
- **智能预测**：基于历史数据预测电量消耗速率和预计用完时间
- **实时监控**：实时展示爬虫状态、进度和日志
- **稳定可靠**：确保系统在各种网络环境下稳定运行

## 二、功能需求

### 2.1 分布式爬虫功能

#### 2.1.1 自动爬取
- **触发时机**：页面加载时自动执行一次爬取
- **执行频率**：每2分钟自动执行一次，当用户持续在线时
- **爬取方式**：利用用户浏览器发起HTTP请求获取目标网页HTML
- **数据提交**：将获取的HTML数据提交至后端API进行解析和存储

#### 2.1.2 手动爬取
- **触发方式**：用户点击"手动爬取"按钮
- **执行流程**：立即触发浏览器爬取任务，无需等待下一次自动执行
- **状态反馈**：爬取过程中提供实时状态反馈

#### 2.1.3 爬取进度与状态
- **进度展示**：显示爬取任务的进度百分比（0-100%）
- **状态指示**：显示当前爬虫状态（空闲/爬取中/成功/失败）
- **倒计时功能**：显示距离下一次自动爬取的剩余时间

### 2.2 数据可视化

#### 2.2.1 总览模块
- **当前剩余电量**：实时显示当前电表剩余电量
- **今日/本周/本月用电**：展示不同时间维度的用电量统计
- **本月预计费用**：基于当前用电量预测本月电费
- **电量耗尽预测**：显示预计电量耗尽的时间和剩余小时数

#### 2.2.2 用电趋势模块
- **24小时趋势**：展示过去24小时的电量变化趋势（折线+柱状图）
- **当天用电**：按小时统计当天用电量分布
- **每日趋势**：展示最近30天的每日用电量趋势
- **每月趋势**：展示最近12个月的每月用电量趋势

### 2.3 日志管理

#### 2.3.1 日志展示
- **日志内容**：显示所有分布式爬取日志（本地+服务器）
- **日志格式**：包含时间戳、操作类型、状态和详细信息
- **日志过滤**：按状态（成功/失败）筛选日志

#### 2.3.2 日志刷新
- **自动刷新**：爬取完成后自动刷新日志
- **手动刷新**：支持用户手动刷新日志

### 2.4 系统管理

#### 2.4.1 数据刷新
- **手动刷新**：用户可手动刷新所有展示数据
- **自动更新**：爬取成功后自动更新展示数据

## 三、非功能需求

### 3.1 性能要求
- **响应时间**：页面加载时间 < 3秒
- **API延迟**：API响应时间 < 1秒
- **并发支持**：支持1000+并发用户同时访问

### 3.2 可靠性要求
- **爬虫成功率**：> 99%
- **系统可用性**：> 99.9%
- **数据准确性**：电量数据解析准确率 > 99.5%

### 3.3 安全性要求
- **CORS配置**：严格的跨域资源共享策略
- **数据传输**：使用HTTPS加密传输数据
- **输入验证**：严格验证所有用户输入和API请求

### 3.4 兼容性要求
- **浏览器兼容**：支持Chrome、Firefox、Safari、Edge等主流浏览器
- **响应式设计**：适配桌面端和移动端

### 3.5 可维护性要求
- **代码结构**：清晰的模块化设计
- **日志记录**：详细的系统运行日志
- **错误处理**：完善的错误捕获和处理机制

## 四、系统架构

### 4.1 整体架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   用户浏览器    │────>│    后端服务器    │────>│    MongoDB      │
│  (分布式爬虫)   │<────│                 │<────│                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 4.2 前端架构
- **技术栈**：React + TypeScript
- **状态管理**：React Hooks (useState, useEffect)
- **网络请求**：原生fetch API
- **UI组件**：自定义组件 + CSS样式

### 4.3 后端架构
- **技术栈**：Node.js + Express
- **路由管理**：Express Router
- **数据存储**：MongoDB
- **中间件**：CORS、Helmet、Compression、Morgan
- **缓存策略**：内存缓存（TTL = 2分钟）

## 五、数据模型

### 5.1 用电数据模型 (Usage)

```json
{
  "_id": ObjectId,          // 唯一标识
  "meter_id": String,       // 电表ID
  "meter_name": String,     // 电表名称
  "remaining_kwh": Number,  // 剩余电量（kWh）
  "collected_at": Date,     // 采集时间
  "created_at": Date,       // 创建时间
  "updated_at": Date        // 更新时间
}
```

### 5.2 预测数据模型 (Prediction)

```json
{
  "predicted_time": Date,   // 预计耗尽时间
  "hours_remaining": Number,// 剩余小时数
  "consumption_rate": Number,// 消耗速率（kWh/h）
  "status": String,         // 状态
  "message": String,        // 消息
  "data_points": Number,    // 数据点数量
  "has_recharge": Boolean,  // 是否有充值记录
  "analysis": Object        // 分析数据
}
```

## 六、API接口

### 6.1 核心接口

#### 6.1.1 上报爬取数据
```
POST /api/reportData
请求体：{ "data": <HTML数据> }
响应：{ "success": true/false, "message": <消息> }
```

#### 6.1.2 获取总览数据
```
GET /api/overview
响应：
{
  "current_remaining": Number,
  "today_usage": Number,
  "week_usage": Number,
  "month_usage": Number,
  "month_cost": Number,
  "predicted_depletion": PredictionData,
  "comparisons": ComparisonData
}
```

#### 6.1.3 获取24小时趋势
```
GET /api/trend/24h
响应：[ { "time": String, "used_kwh": Number, "remaining_kwh": Number } ]
```

#### 6.1.4 获取今日趋势
```
GET /api/trend/today
响应：[ { "hour": Number, "used_kwh": Number } ]
```

#### 6.1.5 获取30天趋势
```
GET /api/trend/30d
响应：[ { "date": String, "used_kwh": Number } ]
```

#### 6.1.6 获取12个月趋势
```
GET /api/trend/monthly
响应：[ { "month": String, "used_kwh": Number } ]
```

#### 6.1.7 获取爬虫日志
```
GET /api/crawler/logs?limit=100
响应：{ "success": true, "logs": [ LogEntry ] }
```

### 6.2 健康检查接口

#### 6.2.1 系统健康检查
```
GET /health
响应：{ "status": "ok", "timestamp": String, "uptime": Number, "mongodb": String }
```

## 七、分布式爬虫实现

### 7.1 爬取流程

1. **触发阶段**：页面加载或定时任务触发爬取
2. **获取数据**：浏览器直接请求目标电力网站获取HTML
3. **提交数据**：将HTML数据通过POST请求发送至后端API
4. **解析数据**：后端使用JSDOM和正则表达式解析剩余电量
5. **存储数据**：将解析后的数据存入MongoDB
6. **更新UI**：前端更新展示数据和爬虫状态

### 7.2 爬取策略

- **防阻塞设计**：爬取过程不影响用户正常使用
- **错误处理**：完善的错误捕获和重试机制
- **状态管理**：实时跟踪爬取进度和状态
- **日志记录**：详细记录每一次爬取的过程和结果

## 八、部署与维护

### 8.1 部署架构

- **主环境**：Railway（支持定时任务和MongoDB插件）
- **备用环境**：Zeabur（同代码仓库，一键部署）
- **前端部署**：打包后置于Express的public目录下

### 8.2 环境变量

- **REACT_APP_API_BASE**：前端API基础URL
- **PORT**：服务器端口
- **MONGO_URI**：MongoDB连接字符串
- **ENABLE_CRAWLER**：是否启用服务器端爬虫（false表示仅使用分布式爬虫）

### 8.3 维护计划

- **定期备份**：每日备份MongoDB数据
- **日志监控**：定期检查系统日志
- **性能优化**：根据实际运行情况优化系统性能
- **安全更新**：及时更新依赖包，修复安全漏洞

## 九、项目进度与里程碑

### 9.1 已完成功能

- ✅ 分布式爬虫功能实现
- ✅ 自动爬取和手动爬取功能
- ✅ 数据可视化模块
- ✅ 智能预测功能
- ✅ 日志管理功能
- ✅ 系统部署（Railway）

### 9.2 待优化功能

- ⏳ 进一步优化分布式爬虫的稳定性
- ⏳ 完善数据预测算法
- ⏳ 增强系统错误处理能力
- ⏳ 优化移动端体验

## 十、风险评估与应对策略

### 10.1 技术风险

| 风险 | 影响 | 应对策略 |
|------|------|----------|
| 目标网站结构变化 | 数据解析失败 | 定期检查解析规则，实现自适应解析 |
| 浏览器跨域限制 | 爬取失败 | 配置正确的CORS头，使用合适的请求模式 |
| 数据库连接中断 | 数据丢失 | 实现连接重试机制，定期备份数据 |

### 10.2 运营风险

| 风险 | 影响 | 应对策略 |
|------|------|----------|
| 用户浏览器兼容性问题 | 部分用户无法使用 | 测试主流浏览器，提供降级方案 |
| 高并发访问 | 系统性能下降 | 优化系统架构，增加缓存机制 |
| 网络波动 | 爬取成功率下降 | 实现重试机制，增加网络状态检测 |

## 十一、结论

本项目实现了一个基于浏览器的分布式电力数据爬取与监控系统，通过创新的分布式爬取方式，有效解决了传统爬虫面临的各种限制。系统功能完善，包括自动爬取、手动爬取、数据可视化、智能预测和日志管理等核心功能，能够为用户提供实时、准确的电力使用情况监控服务。

未来，我们将继续优化系统性能，增强稳定性和用户体验，为用户提供更加优质的电力数据监控服务。