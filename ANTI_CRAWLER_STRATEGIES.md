# 反反爬虫策略文档

## 🛡️ 已实现的反反爬虫手段

### 1. 时间策略
- **爬取频率**: 从10分钟改为15分钟，降低频率
- **随机延迟**: 每次爬取前添加10-40秒随机延迟
- **定时随机化**: 15分钟定时任务添加0-5分钟随机延迟
- **失败延迟**: 爬取失败后添加20-50秒随机延迟

### 2. 请求头优化
- **随机User-Agent**: 7种不同的移动端和桌面端UA轮换
- **完整浏览器头**: 包含Accept、Accept-Language、Accept-Encoding等
- **安全头**: 添加Sec-Fetch-*系列头部
- **Referer伪装**: 使用Google作为Referer
- **Host头**: 正确设置目标主机

### 3. 网络优化
- **超时时间**: 增加到45秒，避免网络波动
- **压缩支持**: 自动处理gzip和deflate压缩
- **连接复用**: 使用keep-alive连接
- **重试机制**: 最多3次重试，每次间隔3-8秒

### 4. 数据解析优化
- **多方法解析**: 4种不同的数据提取方法
- **详细日志**: 记录每个解析步骤
- **容错处理**: 解析失败时尝试其他方法
- **数据验证**: 确保解析出的数据有效

### 5. 数据库优化
- **重复检查**: 避免保存重复时间的数据
- **保存重试**: 数据库保存失败时重试3次
- **时间对齐**: 数据时间对齐到15分钟间隔

## 🔧 技术实现细节

### 随机延迟算法
```javascript
// 启动延迟: 30-90秒
const initialDelay = Math.floor(Math.random() * 60 + 30) * 1000;

// 定时任务延迟: 0-5分钟
const randomDelay = Math.floor(Math.random() * 300) * 1000;

// 爬取前延迟: 10-40秒
const randomDelay = Math.floor(Math.random() * 30000) + 10000;
```

### User-Agent池
- iPhone Safari (iOS 15.0, 14.6, 13.7)
- Android Chrome (Samsung Galaxy)
- Windows Chrome
- macOS Chrome

### 数据解析方法
1. **Label标签解析** (主要方法)
2. **Span标签解析** (备用方法)
3. **Div标签解析** (备用方法)
4. **正则表达式解析** (最后手段)

## 📊 监控指标

### 成功指标
- 数据获取成功率 > 95%
- 平均响应时间 < 30秒
- 数据解析成功率 > 98%

### 异常处理
- 网络超时自动重试
- 解析失败自动重试
- 数据库保存失败自动重试
- 所有异常都有详细日志

## 🚀 部署建议

### Railway部署
- 使用相同的MongoDB连接
- 环境变量配置正确
- 监控日志输出

### 监控要点
- 检查爬虫启动日志
- 监控数据采集频率
- 观察错误日志频率
- 验证数据质量

---

**优化完成！爬虫现在更加稳定和隐蔽！** 🕷️
